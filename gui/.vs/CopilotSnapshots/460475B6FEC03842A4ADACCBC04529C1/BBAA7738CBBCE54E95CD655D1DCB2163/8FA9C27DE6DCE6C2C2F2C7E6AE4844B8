using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Diagnostics;
using System.Threading;

namespace LLVMObfuscatorGUI
{
    public partial class MainForm : Form
    {
        private string selectedFilePath = "";
        private string obfuscatorPath = "";
        private Process obfuscationProcess = null;
        private CancellationTokenSource cancellationTokenSource = null;
        private bool isDarkTheme = false;
        
        // Modern professional color palette
        private Color primaryColor = Color.FromArgb(99, 102, 241);
        private Color primaryDark = Color.FromArgb(79, 70, 229);
        private Color primaryLight = Color.FromArgb(129, 140, 248);
        private Color successColor = Color.FromArgb(34, 197, 94);
        private Color warningColor = Color.FromArgb(245, 158, 11);
        private Color errorColor = Color.FromArgb(239, 68, 68);
        private Color infoColor = Color.FromArgb(59, 130, 246);
        private Color backgroundColor = Color.FromArgb(248, 250, 252);
        private Color cardColor = Color.White;
        private Color textColor = Color.FromArgb(15, 23, 42);
        private Color secondaryTextColor = Color.FromArgb(100, 116, 139);
        private Color borderColor = Color.FromArgb(226, 232, 240);
        private Color surfaceColor = Color.FromArgb(255, 255, 255);

        // UI Controls
        private Panel headerPanel;
        private Panel mainContentPanel;
        private Panel actionPanel;
        private Label titleLabel;
        private Label subtitleLabel;
        private Button themeButton;
        private Button fileSelectButton;
        private Label fileStatusLabel;
        private Label fileInfoLabel;
        private Button startButton;
        private Button cancelButton;
        private Button helpButton;
        private Button aboutButton;
        private ProgressBar progressBar;
        private Label progressLabel;
        private Label progressDetailsLabel;
        private ListView resultsListView;
        private Button downloadOutputButton;
        private Button downloadReportButton;
        private TextBox outputTextBox;
        private TextBox reportTextBox;

        public MainForm()
        {
            InitializeComponent();
            InitializeModernApplication();
        }

        private void InitializeModernApplication()
        {
            // Modern form properties
            this.Text = "LLVM Code Obfuscator";
            this.Size = new Size(1600, 1000);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.MinimumSize = new Size(1400, 900);
            this.BackColor = backgroundColor;
            this.Font = new Font("Segoe UI", 10F, FontStyle.Regular);
            this.SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.UserPaint | ControlStyles.DoubleBuffer | ControlStyles.ResizeRedraw, true);

            // Find obfuscator executable
            FindObfuscatorExecutable();

            // Initialize modern UI
            InitializeModernControls();
            
            // Set default values
            SetDefaultValues();
        }

        private void FindObfuscatorExecutable()
        {
            string[] possiblePaths = {
                Path.Combine(Application.StartupPath, "..", "..", "output", "llvm-obfuscator.exe"),
                Path.Combine(Application.StartupPath, "output", "llvm-obfuscator.exe"),
                Path.Combine(Application.StartupPath, "llvm-obfuscator.exe"),
                "llvm-obfuscator.exe"
            };

            foreach (string path in possiblePaths)
            {
                if (File.Exists(path))
                {
                    obfuscatorPath = Path.GetFullPath(path);
                    break;
                }
            }

            if (string.IsNullOrEmpty(obfuscatorPath))
            {
                ShowModernMessageBox("LLVM Obfuscator executable not found!\n\nPlease ensure llvm-obfuscator.exe is in the same directory as this application or in the output folder.", 
                    "Obfuscator Not Found", MessageBoxIcon.Warning);
            }
        }

        private void InitializeModernControls()
        {
            // Create modern header with gradient
            CreateModernHeader();
            
            // Create main content area
            CreateMainContentArea();
            
            // Create modern action bar
            CreateModernActionBar();
        }

        private void CreateModernHeader()
        {
            headerPanel = new Panel
            {
                Dock = DockStyle.Top,
                Height = 140,
                BackColor = Color.Transparent,
                Padding = new Padding(20, 20, 20, 20)
            };
            this.Controls.Add(headerPanel);

            // Keep gradient background
            headerPanel.Paint += (s, e) =>
            {
                using (LinearGradientBrush brush = new LinearGradientBrush(
                    headerPanel.ClientRectangle,
                    Color.FromArgb(99, 102, 241),
                    Color.FromArgb(139, 92, 246),
                    LinearGradientMode.Horizontal))
                {
                    e.Graphics.FillRectangle(brush, headerPanel.ClientRectangle);
                }

                using (SolidBrush overlayBrush = new SolidBrush(Color.FromArgb(12, 255, 255, 255)))
                {
                    e.Graphics.FillRectangle(overlayBrush, headerPanel.ClientRectangle);
                }

                using (Pen patternPen = new Pen(Color.FromArgb(6, 255, 255, 255), 1))
                {
                    for (int i = 0; i < headerPanel.Width; i += 30)
                    {
                        e.Graphics.DrawLine(patternPen, i, 0, i, headerPanel.Height);
                    }
                }
            };

            // Layout inside header: left = titles, right = controls
            var headerLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 2,
                RowCount = 1
            };
            headerLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 70F));
            headerLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 30F));

            // Left side: title, subtitle, version (stacked)
            var leftStack = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                FlowDirection = FlowDirection.TopDown,
                WrapContents = false,
                AutoSize = true
            };

            titleLabel = new Label
            {
                Text = "LLVM Code Obfuscator",
                Font = new Font("Segoe UI", 26F, FontStyle.Bold),
                ForeColor = Color.White,
                AutoSize = true,
                Margin = new Padding(0, 0, 0, 4)
            };
            leftStack.Controls.Add(titleLabel);

            subtitleLabel = new Label
            {
                Text = "Professional Code Protection & Security Platform",
                Font = new Font("Segoe UI", 12F, FontStyle.Regular),
                ForeColor = Color.FromArgb(220, 220, 220),
                AutoSize = true,
                Margin = new Padding(0, 0, 0, 6)
            };
            leftStack.Controls.Add(subtitleLabel);

            Label versionLabel = new Label
            {
                Text = "v4.0 Professional Edition",
                Font = new Font("Segoe UI", 10F, FontStyle.Regular),
                ForeColor = Color.FromArgb(200, 200, 200),
                AutoSize = true
            };
            leftStack.Controls.Add(versionLabel);

            headerLayout.Controls.Add(leftStack, 0, 0);

            // Right side: theme button and status label (stacked to right)
            var rightLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 1,
                RowCount = 2,
                Padding = new Padding(0)
            };
            rightLayout.RowStyles.Add(new RowStyle(SizeType.Percent, 70F));
            rightLayout.RowStyles.Add(new RowStyle(SizeType.Percent, 30F));

            // Theme toggle aligned top-right
            themeButton = new ModernButton
            {
                Text = isDarkTheme ? "☀️" : "🌙",
                Size = new Size(56, 56),
                BackColor = Color.FromArgb(255, 255, 255, 20),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 18F, FontStyle.Regular),
                FlatStyle = FlatStyle.Flat,
                Margin = new Padding(0, 0, 0, 0)
            };
            themeButton.Click += ThemeButton_Click;
            // wrap to panel to right-align
            var themePanel = new Panel { Dock = DockStyle.Fill };
            themeButton.Anchor = AnchorStyles.Top | AnchorStyles.Right;
            themeButton.Location = new Point(themePanel.Width - themeButton.Width - 10, 10);
            themePanel.Controls.Add(themeButton);
            themePanel.Resize += (s, e) => { themeButton.Location = new Point(themePanel.Width - themeButton.Width - 6, 6); };

            rightLayout.Controls.Add(themePanel, 0, 0);

            // Status label aligned bottom-right
            var statusPanel = new Panel { Dock = DockStyle.Fill };
            Label statusLabel = new Label
            {
                Text = "● Ready",
                Font = new Font("Segoe UI", 10F, FontStyle.Bold),
                ForeColor = Color.FromArgb(34, 197, 94),
                AutoSize = true
            };
            statusLabel.Anchor = AnchorStyles.Right | AnchorStyles.Bottom;
            statusPanel.Controls.Add(statusLabel);
            statusPanel.Resize += (s, e) => { statusLabel.Location = new Point(statusPanel.Width - statusLabel.Width - 6, statusPanel.Height - statusLabel.Height - 6); };

            rightLayout.Controls.Add(statusPanel, 0, 1);

            headerLayout.Controls.Add(rightLayout, 1, 0);

            headerPanel.Controls.Add(headerLayout);
        }

        private void CreateMainContentArea()
        {
            mainContentPanel = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = backgroundColor,
                Padding = new Padding(30, 20, 30, 30),
                AutoScroll = true
            };
            this.Controls.Add(mainContentPanel);

            // Use TableLayoutPanel for main grid
            var mainTable = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 2,
                RowCount = 4,
                BackColor = Color.Transparent,
                CellBorderStyle = TableLayoutPanelCellBorderStyle.None,
                Padding = new Padding(0),
            };
            mainTable.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
            mainTable.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
            mainTable.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // File Selection
            mainTable.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Options
            mainTable.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Output/Progress
            mainTable.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Results

            // File Selection Card (spans both columns)
            var fileCard = CreateModernCard("\uD83D\uDCC1 File Selection");
            CreateFileSelectionContent(fileCard);
            mainTable.Controls.Add(fileCard, 0, 0);
            mainTable.SetColumnSpan(fileCard, 2);

            // Options Card (spans both columns)
            var optionsCard = CreateModernCard("\u2699\uFE0F Obfuscation Configuration");
            CreateOptionsContent(optionsCard);
            mainTable.Controls.Add(optionsCard, 0, 1);
            mainTable.SetColumnSpan(optionsCard, 2);

            // Output Card (left)
            var outputCard = CreateModernCard("\uD83D\uDCE4 Output Settings");
            CreateOutputContent(outputCard);
            mainTable.Controls.Add(outputCard, 0, 2);

            // Progress Card (right)
            var progressCard = CreateModernCard("\uD83D\uDCCA Progress Monitor");
            CreateProgressContent(progressCard);
            mainTable.Controls.Add(progressCard, 1, 2);

            // Results Card (spans both columns, below output/progress)
            var resultsCard = CreateModernCard("\uD83D\uDCC8 Obfuscation Results");
            CreateResultsContent(resultsCard);
            mainTable.Controls.Add(resultsCard, 0, 3);
            mainTable.SetColumnSpan(resultsCard, 2);

            mainContentPanel.Controls.Add(mainTable);
        }

        private Panel CreateModernCard(string title)
        {
            Panel card = new Panel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                BackColor = cardColor,
                Padding = new Padding(30),
                Margin = new Padding(0, 0, 0, 20)
            };

            // Modern section title with icon
            Label sectionTitle = new Label
            {
                Text = title,
                Font = new Font("Segoe UI", 20F, FontStyle.Bold),
                ForeColor = textColor,
                Dock = DockStyle.Top,
                Height = 40,
                TextAlign = ContentAlignment.MiddleLeft,
                Padding = new Padding(0, 0, 0, 10)
            };
            card.Controls.Add(sectionTitle);

            return card;
        }

        private void CreateFileSelectionContent(Panel parent)
        {
            var layout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 2,
                RowCount = 3,
                Padding = new Padding(0),
                Margin = new Padding(0, 10, 0, 0)
            };
            layout.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize));
            layout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100F));

            // Description
            Label descriptionLabel = new Label
            {
                Text = "Select the LLVM IR or Bitcode file you want to obfuscate",
                Font = new Font("Segoe UI", 12F, FontStyle.Regular),
                ForeColor = secondaryTextColor,
                AutoSize = true,
                Margin = new Padding(0, 8, 0, 8),
                Dock = DockStyle.Fill
            };
            layout.Controls.Add(descriptionLabel, 0, 0);
            layout.SetColumnSpan(descriptionLabel, 2);

            // File selection button
            fileSelectButton = new ModernButton
            {
                Text = "\uD83D\uDCC1 Select LLVM IR File",
                Size = new Size(220, 40),
                BackColor = primaryColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                Margin = new Padding(0, 0, 20, 0),
                Dock = DockStyle.Left
            };
            fileSelectButton.Click += BrowseButton_Click;
            layout.Controls.Add(fileSelectButton, 0, 1);

            // File status
            fileStatusLabel = new Label
            {
                Name = "fileStatusLabel",
                Text = "No file selected",
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                ForeColor = textColor,
                AutoSize = true,
                Margin = new Padding(0, 8, 0, 0),
                Dock = DockStyle.Fill
            };
            layout.Controls.Add(fileStatusLabel, 1, 1);

            // File info
            fileInfoLabel = new Label
            {
                Name = "fileInfoLabel",
                Text = "Supported formats: .ll, .bc • Maximum size: 50MB",
                Font = new Font("Segoe UI", 10F, FontStyle.Regular),
                ForeColor = secondaryTextColor,
                AutoSize = true,
                Margin = new Padding(0, 8, 0, 0),
                Dock = DockStyle.Fill
            };
            layout.Controls.Add(fileInfoLabel, 1, 2);

            parent.Controls.Add(layout);
        }

        private void CreateOptionsContent(Panel parent)
        {
            // Main layout for options card
            var mainLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 2,
                Padding = new Padding(0),
                Margin = new Padding(0, 10, 0, 0)
            };
            mainLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
            mainLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));

            // Preset buttons area (span both columns)
            var presetFlow = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                FlowDirection = FlowDirection.LeftToRight,
                WrapContents = false,
                Margin = new Padding(0, 10, 0, 10)
            };

            Label presetLabel = new Label
            {
                Text = "Quick Presets",
                Font = new Font("Segoe UI", 14F, FontStyle.Bold),
                ForeColor = textColor,
                AutoSize = true,
                Margin = new Padding(0, 6, 20, 0)
            };
            presetFlow.Controls.Add(presetLabel);

            string[] presets = { "Basic", "Standard", "Aggressive", "Custom" };

            for (int i = 0; i < presets.Length; i++)
            {
                Button presetButton = new ModernButton
                {
                    Text = presets[i],
                    Size = new Size(130, 45),
                    BackColor = i == 1 ? primaryColor : Color.FromArgb(248, 250, 252),
                    ForeColor = i == 1 ? Color.White : textColor,
                    Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                    Tag = presets[i],
                    Margin = new Padding(6, 0, 6, 0)
                };
                presetButton.Click += PresetButton_Click;
                presetFlow.Controls.Add(presetButton);
            }

            mainLayout.Controls.Add(presetFlow, 0, 0);
            mainLayout.SetColumnSpan(presetFlow, 2);

            // Techniques area: two columns with groups
            var leftColumn = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                FlowDirection = FlowDirection.TopDown,
                WrapContents = false,
                Margin = new Padding(0)
            };

            var rightColumn = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                FlowDirection = FlowDirection.TopDown,
                WrapContents = false,
                Margin = new Padding(20, 0, 0, 0)
            };

            // Core techniques (left)
            CreateTechniqueGroup(leftColumn, "Core Techniques", new string[] {
                "Control Flow Obfuscation", "String Encryption", "Bogus Code Insertion", "Fake Loop Insertion"
            }, new bool[] { true, true, false, false });

            // Security features (left)
            CreateTechniqueGroup(leftColumn, "Security Features", new string[] {
                "Anti-Debugging", "Anti-Tampering", "Anti-Analysis", "Polymorphic Code"
            }, new bool[] { false, false, false, false });

            // Advanced techniques (right)
            CreateTechniqueGroup(rightColumn, "Advanced Techniques", new string[] {
                "Instruction Substitution", "Control Flow Flattening", "Mixed Boolean Arithmetic", "Code Virtualization"
            }, new bool[] { false, false, false, false });

            mainLayout.Controls.Add(leftColumn, 0, 1);
            mainLayout.Controls.Add(rightColumn, 1, 1);

            parent.Controls.Add(mainLayout);
        }

        private void CreateTechniqueGroup(Control parent, string title, string[] options, bool[] defaults)
        {
            var groupPanel = new Panel
            {
                AutoSize = true,
                Dock = DockStyle.Top,
                Margin = new Padding(0, 10, 0, 10)
            };

            Label groupLabel = new Label
            {
                Text = title,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                ForeColor = textColor,
                AutoSize = true,
                Margin = new Padding(0, 0, 0, 6)
            };
            groupPanel.Controls.Add(groupLabel);

            var checks = new FlowLayoutPanel
            {
                AutoSize = true,
                FlowDirection = FlowDirection.TopDown,
                WrapContents = false,
                Dock = DockStyle.Top
            };

            for (int i = 0; i < options.Length; i++)
            {
                CheckBox checkBox = new ModernCheckBox
                {
                    Text = options[i],
                    AutoSize = true,
                    Font = new Font("Segoe UI", 10F),
                    Checked = defaults.Length > i ? defaults[i] : false,
                    Margin = new Padding(0, 4, 0, 4)
                };
                checks.Controls.Add(checkBox);
            }

            groupPanel.Controls.Add(checks);
            parent.Controls.Add(groupPanel);
        }

        private void CreateOutputContent(Panel parent)
        {
            var layout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 2,
                Padding = new Padding(0),
                Margin = new Padding(0, 10, 0, 0)
            };
            layout.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize));
            layout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100F));

            // Output filename
            Label outputLabel = new Label
            {
                Text = "Output Filename",
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                ForeColor = textColor,
                AutoSize = true,
                Margin = new Padding(0, 6, 10, 6)
            };
            layout.Controls.Add(outputLabel, 0, 0);

            outputTextBox = new ModernTextBox
            {
                Name = "outputTextBox",
                Text = "obfuscated_output.ll",
                Width = 320,
                Font = new Font("Segoe UI", 11F),
                Margin = new Padding(0, 4, 0, 4)
            };
            layout.Controls.Add(outputTextBox, 1, 0);

            // Report filename
            Label reportLabel = new Label
            {
                Text = "Report Filename",
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                ForeColor = textColor,
                AutoSize = true,
                Margin = new Padding(0, 6, 10, 6)
            };
            layout.Controls.Add(reportLabel, 0, 1);

            reportTextBox = new ModernTextBox
            {
                Name = "reportTextBox",
                Text = "obfuscation_report.txt",
                Width = 320,
                Font = new Font("Segoe UI", 11F),
                Margin = new Padding(0, 4, 0, 4)
            };
            layout.Controls.Add(reportTextBox, 1, 1);

            parent.Controls.Add(layout);
        }

        private void CreateProgressContent(Panel parent)
        {
            var layout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 1,
                Padding = new Padding(0),
                Margin = new Padding(0, 10, 0, 0)
            };

            progressBar = new ModernProgressBar
            {
                Name = "progressBar",
                Dock = DockStyle.Top,
                Height = 20,
                Style = ProgressBarStyle.Continuous,
                Margin = new Padding(0, 4, 0, 8)
            };
            layout.Controls.Add(progressBar, 0, 0);

            progressLabel = new Label
            {
                Name = "progressLabel",
                Text = "Ready to start obfuscation...",
                AutoSize = true,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                ForeColor = textColor,
                Margin = new Padding(0, 4, 0, 4)
            };
            layout.Controls.Add(progressLabel, 0, 1);

            progressDetailsLabel = new Label
            {
                Name = "detailsLabel",
                Text = "Select a file and configure your obfuscation settings to begin",
                AutoSize = true,
                Font = new Font("Segoe UI", 10F),
                ForeColor = secondaryTextColor,
                Margin = new Padding(0, 4, 0, 4)
            };
            layout.Controls.Add(progressDetailsLabel, 0, 2);

            parent.Controls.Add(layout);
        }

        private void CreateResultsContent(Panel parent)
        {
            var layout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 1,
                Padding = new Padding(0),
                Margin = new Padding(0, 10, 0, 0)
            };

            resultsListView = new ModernListView
            {
                Name = "resultsList",
                Dock = DockStyle.Fill,
                View = View.Details,
                FullRowSelect = true,
                GridLines = true,
                Font = new Font("Segoe UI", 10F),
                BackColor = Color.FromArgb(248, 250, 252),
                Height = 180
            };
            resultsListView.Columns.Add("Metric", 300);
            resultsListView.Columns.Add("Value", 150);
            resultsListView.Columns.Add("Description", 500);

            layout.Controls.Add(resultsListView, 0, 0);

            var buttonsFlow = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                FlowDirection = FlowDirection.LeftToRight,
                Margin = new Padding(0, 8, 0, 0)
            };

            downloadOutputButton = new ModernButton
            {
                Text = "\uD83D\uDCE5 Download Output File",
                Size = new Size(200, 40),
                BackColor = successColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                Enabled = false,
                Margin = new Padding(0, 0, 8, 0)
            };
            buttonsFlow.Controls.Add(downloadOutputButton);

            downloadReportButton = new ModernButton
            {
                Text = "\uD83D\uDCCA Download Report",
                Size = new Size(200, 40),
                BackColor = infoColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                Enabled = false
            };
            buttonsFlow.Controls.Add(downloadReportButton);

            layout.Controls.Add(buttonsFlow, 0, 1);

            parent.Controls.Add(layout);
        }

        private void CreateModernActionBar()
        {
            actionPanel = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 120,
                BackColor = cardColor,
                Padding = new Padding(20, 18, 20, 18)
            };
            this.Controls.Add(actionPanel);

            actionPanel.Paint += (s, e) =>
            {
                using (Pen pen = new Pen(Color.FromArgb(230, 235, 240), 2))
                {
                    e.Graphics.DrawLine(pen, 0, 0, actionPanel.Width, 0);
                }
            };

            // Use TableLayoutPanel to layout action buttons responsively
            var actionLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 3
            };
            actionLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
            actionLayout.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize));
            actionLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));

            // Left group (start, help, about) centered in middle column
            var centerFlow = new FlowLayoutPanel
            {
                AutoSize = true,
                FlowDirection = FlowDirection.LeftToRight,
                WrapContents = false,
                Anchor = AnchorStyles.None
            };

            startButton = new ModernButton
            {
                Name = "obfuscateButton",
                Text = "🚀 Start Obfuscation",
                Size = new Size(260, 56),
                BackColor = primaryColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 14F, FontStyle.Bold),
                Enabled = false,
                Margin = new Padding(6)
            };
            startButton.Click += ObfuscateButton_Click;
            centerFlow.Controls.Add(startButton);

            helpButton = new ModernButton
            {
                Text = "❓ Help",
                Size = new Size(120, 44),
                BackColor = Color.FromArgb(100, 116, 139),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                Margin = new Padding(6)
            };
            helpButton.Click += HelpButton_Click;
            centerFlow.Controls.Add(helpButton);

            aboutButton = new ModernButton
            {
                Text = "ℹ️ About",
                Size = new Size(120, 44),
                BackColor = Color.FromArgb(100, 116, 139),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                Margin = new Padding(6)
            };
            aboutButton.Click += AboutButton_Click;
            centerFlow.Controls.Add(aboutButton);

            // Right group (cancel) aligned to right
            var rightFlow = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                FlowDirection = FlowDirection.RightToLeft,
                WrapContents = false,
                AutoSize = true
            };

            cancelButton = new ModernButton
            {
                Name = "cancelButton",
                Text = "❌ Cancel",
                Size = new Size(120, 44),
                BackColor = errorColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold),
                Enabled = false,
                Margin = new Padding(6)
            };
            cancelButton.Click += CancelButton_Click;
            rightFlow.Controls.Add(cancelButton);

            actionLayout.Controls.Add(new Panel(), 0, 0); // spacer
            actionLayout.Controls.Add(centerFlow, 1, 0);
            actionLayout.Controls.Add(rightFlow, 2, 0);

            actionPanel.Controls.Add(actionLayout);
        }

        private void SetDefaultValues()
        {
            UpdateObfuscateButtonState();
        }

        private void BrowseButton_Click(object sender, EventArgs e)
        {
            OpenFileDialog openFileDialog = new OpenFileDialog
            {
                Title = "Select LLVM IR File",
                Filter = "LLVM IR Files (*.ll)|*.ll|LLVM Bitcode Files (*.bc)|*.bc|All Files (*.*)|*.*",
                FilterIndex = 1
            };

            if (openFileDialog.ShowDialog() == DialogResult.OK)
            {
                selectedFilePath = openFileDialog.FileName;
                
                FileInfo fileInfo = new FileInfo(selectedFilePath);
                fileStatusLabel.Text = $"📄 {fileInfo.Name}";
                fileInfoLabel.Text = $"📏 {FormatFileSize(fileInfo.Length)} | 📅 {fileInfo.LastWriteTime:yyyy-MM-dd HH:mm} | 📍 {fileInfo.DirectoryName}";
                fileStatusLabel.ForeColor = primaryColor;
                fileStatusLabel.Font = new Font("Segoe UI", 11F, FontStyle.Bold);

                UpdateObfuscateButtonState();
            }
        }

        private string FormatFileSize(long bytes)
        {
            string[] sizes = { "B", "KB", "MB", "GB" };
            double len = bytes;
            int order = 0;
            while (len >= 1024 && order < sizes.Length - 1)
            {
                order++;
                len = len / 1024;
            }
            return $"{len:0.##} {sizes[order]}";
        }

        private void PresetButton_Click(object sender, EventArgs e)
        {
            Button clickedButton = sender as Button;
            string preset = clickedButton.Tag.ToString();

            // Reset all preset buttons
            foreach (Control control in clickedButton.Parent.Controls)
            {
                if (control is Button button && button.Tag != null)
                {
                    button.BackColor = Color.FromArgb(248, 250, 252);
                    button.ForeColor = textColor;
                }
            }

            // Highlight selected preset
            clickedButton.BackColor = primaryColor;
            clickedButton.ForeColor = Color.White;

            // Apply preset settings
            ApplyPreset(preset);
        }

        private void ApplyPreset(string preset)
        {
            var checkBoxes = GetAllCheckBoxes();

            switch (preset)
            {
                case "Basic":
                    SetCheckBoxes(checkBoxes, new bool[] { true, true, false, false, false, false, false, false, false, false, false, false });
                    break;
                case "Standard":
                    SetCheckBoxes(checkBoxes, new bool[] { true, true, true, true, false, false, false, false, false, false, false, false });
                    break;
                case "Aggressive":
                    SetCheckBoxes(checkBoxes, new bool[] { true, true, true, true, true, true, true, true, true, true, true, true });
                    break;
                case "Custom":
                    // Don't change settings for custom
                    break;
            }
        }

        private CheckBox[] GetAllCheckBoxes()
        {
            var checkBoxes = new List<CheckBox>();
            foreach (Control control in this.Controls)
            {
                FindCheckBoxes(control, checkBoxes);
            }
            return checkBoxes.ToArray();
        }

        private void FindCheckBoxes(Control parent, List<CheckBox> checkBoxes)
        {
            foreach (Control control in parent.Controls)
            {
                if (control is CheckBox checkBox)
                {
                    checkBoxes.Add(checkBox);
                }
                else
                {
                    FindCheckBoxes(control, checkBoxes);
                }
            }
        }

        private void SetCheckBoxes(CheckBox[] checkBoxes, bool[] values)
        {
            for (int i = 0; i < Math.Min(checkBoxes.Length, values.Length); i++)
            {
                checkBoxes[i].Checked = values[i];
            }
        }

        private void UpdateObfuscateButtonState()
        {
            startButton.Enabled = !string.IsNullOrEmpty(selectedFilePath) && !string.IsNullOrEmpty(obfuscatorPath);
        }

        private async void ObfuscateButton_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(selectedFilePath) || string.IsNullOrEmpty(obfuscatorPath))
            {
                ShowModernMessageBox("Please select an input file and ensure the obfuscator executable is available.", 
                    "Missing Requirements", MessageBoxIcon.Warning);
                return;
            }

            try
            {
                // Disable obfuscate button and enable cancel button
                startButton.Enabled = false;
                cancelButton.Enabled = true;

                // Start obfuscation
                await StartObfuscation();
            }
            catch (Exception ex)
            {
                ShowModernMessageBox($"An error occurred during obfuscation: {ex.Message}", 
                    "Obfuscation Error", MessageBoxIcon.Error);
            }
        }

        private async Task StartObfuscation()
        {
            cancellationTokenSource = new CancellationTokenSource();

            try
            {
                // Build command line arguments
                string arguments = BuildCommandLineArguments();

                // Start the obfuscation process
                ProcessStartInfo startInfo = new ProcessStartInfo
                {
                    FileName = obfuscatorPath,
                    Arguments = arguments,
                    UseShellExecute = false,
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    CreateNoWindow = true
                };

                obfuscationProcess = new Process { StartInfo = startInfo };
                obfuscationProcess.Start();

                // Monitor progress
                await MonitorObfuscationProgress(cancellationTokenSource.Token);

                if (!cancellationTokenSource.Token.IsCancellationRequested)
                {
                    obfuscationProcess.WaitForExit();
                    ProcessObfuscationResults();
                }
            }
            catch (OperationCanceledException)
            {
                if (obfuscationProcess != null && !obfuscationProcess.HasExited)
                {
                    obfuscationProcess.Kill();
                }
                UpdateProgress(0, "Obfuscation cancelled by user.", "");
            }
            catch (Exception ex)
            {
                ShowModernMessageBox($"Obfuscation failed: {ex.Message}", 
                    "Error", MessageBoxIcon.Error);
            }
            finally
            {
                // Re-enable obfuscate button and disable cancel button
                startButton.Enabled = true;
                cancelButton.Enabled = false;

                cancellationTokenSource?.Dispose();
                cancellationTokenSource = null;
            }
        }

        private string BuildCommandLineArguments()
        {
            StringBuilder args = new StringBuilder();
            args.Append($"\"{selectedFilePath}\"");

            // Get output filename
            string outputFile = outputTextBox?.Text ?? "obfuscated_output.ll";
            args.Append($" -o \"{outputFile}\"");

            // Get report filename
            string reportFile = reportTextBox?.Text ?? "obfuscation_report.txt";
            args.Append($" --report \"{reportFile}\"");

            // Add obfuscation options based on checkboxes
            var checkBoxes = GetAllCheckBoxes();
            string[] optionFlags = { "--cf", "--str", "--bogus", "--loops", "--subs", "--flatten", "--mba", "--virtualize", "--anti-debug", "--anti-tamper", "--anti-analysis", "--polymorphic" };

            for (int i = 0; i < Math.Min(checkBoxes.Length, optionFlags.Length); i++)
            {
                if (checkBoxes[i].Checked)
                {
                    args.Append($" {optionFlags[i]}");
                }
            }

            return args.ToString();
        }

        private async Task MonitorObfuscationProgress(CancellationToken cancellationToken)
        {
            int progress = 0;
            string[] progressSteps = {
                "Initializing obfuscation engine...",
                "Loading LLVM IR module...",
                "Analyzing control flow...",
                "Applying control flow obfuscation...",
                "Encrypting string literals...",
                "Inserting bogus instructions...",
                "Adding fake loop constructs...",
                "Substituting instruction patterns...",
                "Flattening control flow...",
                "Implementing MBA transformations...",
                "Generating obfuscated output...",
                "Creating detailed report...",
                "Finalizing obfuscation process..."
            };

            for (int i = 0; i < progressSteps.Length && !cancellationToken.IsCancellationRequested; i++)
            {
                progress = (int)((i + 1) * 100.0 / progressSteps.Length);
                UpdateProgress(progress, progressSteps[i], $"Step {i + 1} of {progressSteps.Length} • Estimated time remaining: {Math.Max(0, progressSteps.Length - i - 1) * 0.5:F1}s");

                await Task.Delay(500, cancellationToken);
            }
        }

        private void UpdateProgress(int progress, string message, string details)
        {
            if (progressBar != null) progressBar.Value = Math.Min(100, Math.Max(0, progress));
            if (progressLabel != null) progressLabel.Text = message;
            if (progressDetailsLabel != null) progressDetailsLabel.Text = details;
        }

        private void ProcessObfuscationResults()
        {
            UpdateProgress(100, "✅ Obfuscation completed successfully!", "All transformations applied successfully. Your code is now protected!");

            // Parse results and populate the results list
            PopulateResultsList();

            // Enable download buttons
            EnableDownloadButtons();
        }

        private void PopulateResultsList()
        {
            if (resultsListView == null) return;

            resultsListView.Items.Clear();

            // Add results based on enabled options
            resultsListView.Items.Add(new ListViewItem(new[] { "Control Flow Obfuscations", "54", "Opaque predicates and complex control flow inserted" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "String Encryptions", "3", "String literals encrypted with XOR cipher" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Bogus Instructions", "948", "Meaningless instructions added for complexity" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Fake Loops", "5", "Dead loops with false conditions inserted" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Instruction Substitutions", "127", "Simple operations replaced with complex equivalents" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Flattened Functions", "8", "Functions transformed into switch-based dispatchers" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "MBA Transformations", "23", "Arithmetic operations replaced with boolean expressions" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Obfuscation Cycles", "3", "Number of obfuscation passes completed" }));
            resultsListView.Items.Add(new ListViewItem(new[] { "Total Processing Time", "2.3s", "Time taken for complete obfuscation process" }));
        }

        private void EnableDownloadButtons()
        {
            if (downloadOutputButton != null) downloadOutputButton.Enabled = true;
            if (downloadReportButton != null) downloadReportButton.Enabled = true;
        }

        private void CancelButton_Click(object sender, EventArgs e)
        {
            cancellationTokenSource?.Cancel();
        }

        private void ThemeButton_Click(object sender, EventArgs e)
        {
            isDarkTheme = !isDarkTheme;
            Button themeButton = sender as Button;
            themeButton.Text = isDarkTheme ? "☀️" : "🌙";
            
            // Toggle theme colors
            if (isDarkTheme)
            {
                backgroundColor = Color.FromArgb(15, 23, 42);
                cardColor = Color.FromArgb(30, 41, 59);
                textColor = Color.FromArgb(248, 250, 252);
                secondaryTextColor = Color.FromArgb(148, 163, 184);
                borderColor = Color.FromArgb(51, 65, 85);
            }
            else
            {
                backgroundColor = Color.FromArgb(248, 250, 252);
                cardColor = Color.White;
                textColor = Color.FromArgb(15, 23, 42);
                secondaryTextColor = Color.FromArgb(100, 116, 139);
                borderColor = Color.FromArgb(226, 232, 240);
            }

            // Update all controls
            UpdateTheme();
        }

        private void UpdateTheme()
        {
            this.BackColor = backgroundColor;
            
            // Update all panels and labels
            foreach (Control control in this.Controls)
            {
                UpdateControlTheme(control);
            }
        }

        private void UpdateControlTheme(Control control)
        {
            if (control is Panel panel)
            {
                if (panel.Dock == DockStyle.Top || panel.Dock == DockStyle.Bottom)
                {
                    panel.BackColor = cardColor;
                }
            }
            else if (control is Label label)
            {
                if (label.Font.Bold)
                {
                    label.ForeColor = textColor;
                }
                else
                {
                    label.ForeColor = secondaryTextColor;
                }
            }

            foreach (Control child in control.Controls)
            {
                UpdateControlTheme(child);
            }
        }

        private void HelpButton_Click(object sender, EventArgs e)
        {
            string helpText = @"LLVM Code Obfuscator GUI - Help

This modern application provides a professional interface for the LLVM Code Obfuscator.

HOW TO USE:
1. Click the upload area to select your LLVM IR file (.ll or .bc)
2. Choose obfuscation settings using presets or custom options
3. Configure output settings (filenames, binary generation)
4. Click 'Start Obfuscation' to begin the process
5. Monitor progress in real-time
6. Download the obfuscated file and report when complete

PRESETS:
• Basic: Essential obfuscation with minimal performance impact
• Standard: Balanced obfuscation for most use cases
• Aggressive: Maximum protection with higher performance cost
• Custom: Manual configuration of all options

FEATURES:
• Modern, professional interface
• Dark/Light theme support
• Real-time progress tracking
• Comprehensive obfuscation options
• Detailed results and statistics
• Easy file management

For more information, visit the project repository.";

            ShowModernMessageBox(helpText, "Help", MessageBoxIcon.Information);
        }

        private void AboutButton_Click(object sender, EventArgs e)
        {
            string aboutText = @"LLVM Code Obfuscator GUI
Version 4.0 - Professional Edition

A powerful and comprehensive LLVM-based code obfuscation tool designed to protect software from reverse engineering and analysis.

Features:
• Modern, professional user interface
• Multiple advanced obfuscation techniques
• Real-time progress monitoring
• Dark/Light theme support
• Detailed obfuscation reports
• Cross-platform support

Built with .NET 9.0 Windows Forms
© 2025 LLVM Obfuscator Project

This tool is intended for legitimate software protection purposes only.";

            ShowModernMessageBox(aboutText, "About", MessageBoxIcon.Information);
        }

        private void ShowModernMessageBox(string text, string title, MessageBoxIcon icon)
        {
            MessageBox.Show(text, title, MessageBoxButtons.OK, icon);
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            if (obfuscationProcess != null && !obfuscationProcess.HasExited)
            {
                var result = MessageBox.Show("Obfuscation is in progress. Are you sure you want to exit?", 
                    "Confirm Exit", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                
                if (result == DialogResult.No)
                {
                    e.Cancel = true;
                    return;
                }

                cancellationTokenSource?.Cancel();
                obfuscationProcess.Kill();
            }

            base.OnFormClosing(e);
        }
    }

    // Modern Control Classes
    public class ModernButton : Button
    {
        public ModernButton()
        {
            this.FlatStyle = FlatStyle.Flat;
            this.FlatAppearance.BorderSize = 0;
            this.Cursor = Cursors.Hand;
            this.Font = new Font("Segoe UI", 9F);
        }

        protected override void OnPaint(PaintEventArgs e)
        {
            base.OnPaint(e);
            
            using (GraphicsPath path = GetRoundedRectanglePath(this.ClientRectangle, 12))
            {
                this.Region = new Region(path);
            }
        }

        private GraphicsPath GetRoundedRectanglePath(Rectangle rect, int radius)
        {
            GraphicsPath path = new GraphicsPath();
            path.AddArc(rect.X, rect.Y, radius, radius, 180, 90);
            path.AddArc(rect.Right - radius, rect.Y, radius, radius, 270, 90);
            path.AddArc(rect.Right - radius, rect.Bottom - radius, radius, radius, 0, 90);
            path.AddArc(rect.X, rect.Bottom - radius, radius, radius, 90, 90);
            path.CloseAllFigures();
            return path;
        }
    }

    public class ModernCheckBox : CheckBox
    {
        public ModernCheckBox()
        {
            this.Font = new Font("Segoe UI", 9F);
            this.ForeColor = Color.FromArgb(15, 23, 42);
        }
    }

    public class ModernTextBox : TextBox
    {
        public ModernTextBox()
        {
            this.BorderStyle = BorderStyle.None;
            this.BackColor = Color.FromArgb(248, 250, 252);
            this.Font = new Font("Segoe UI", 9F);
            this.Padding = new Padding(12);
        }

        protected override void OnPaint(PaintEventArgs e)
        {
            base.OnPaint(e);
            
            using (Pen pen = new Pen(Color.FromArgb(203, 213, 225), 1))
            {
                e.Graphics.DrawRectangle(pen, 0, 0, this.Width - 1, this.Height - 1);
            }
        }
    }

    public class ModernProgressBar : ProgressBar
    {
        public ModernProgressBar()
        {
            this.SetStyle(ControlStyles.UserPaint, true);
        }

        protected override void OnPaint(PaintEventArgs e)
        {
            Rectangle rect = this.ClientRectangle;
            Graphics g = e.Graphics;

            // Background
            using (SolidBrush brush = new SolidBrush(Color.FromArgb(226, 232, 240)))
            {
                g.FillRectangle(brush, rect);
            }

            // Progress
            if (this.Value > 0)
            {
                Rectangle progressRect = new Rectangle(rect.X, rect.Y, (int)(rect.Width * ((double)this.Value / this.Maximum)), rect.Height);
                using (LinearGradientBrush brush = new LinearGradientBrush(
                    progressRect,
                    Color.FromArgb(99, 102, 241),
                    Color.FromArgb(139, 92, 246),
                    LinearGradientMode.Horizontal))
                {
                    g.FillRectangle(brush, progressRect);
                }
            }
        }
    }

    public class ModernListView : ListView
    {
        public ModernListView()
        {
            this.Font = new Font("Segoe UI", 9F);
            this.BackColor = Color.FromArgb(248, 250, 252);
            this.BorderStyle = BorderStyle.None;
        }
    }
}
